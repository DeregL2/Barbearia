<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel Barbeiro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .nav-pills .nav-link.active { background-color: var(--gold); color: #000; font-weight: bold; }
        .nav-pills .nav-link { color: var(--gold); }
    </style>
</head>
<body class="bg-admin">

    <nav class="navbar navbar-custom mb-4">
        <div class="container d-flex justify-content-between">
            <span class="brand-font h5 m-0 text-white">‚úÇÔ∏è √Årea do Profissional</span>
            <button onclick="logout()" class="btn btn-outline-danger btn-sm">SAIR</button>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="text-center mb-4">
            <h2 id="ola-barbeiro" class="text-white fw-bold">Ol√°, Barbeiro</h2>
        </div>

        <ul class="nav nav-pills justify-content-center mb-4" id="pills-tab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="pills-agenda-tab" data-bs-toggle="pill" data-bs-target="#pills-agenda" type="button">üìÖ Minha Agenda</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="pills-horarios-tab" data-bs-toggle="pill" data-bs-target="#pills-horarios" type="button">‚öôÔ∏è Definir Hor√°rios</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="pills-agenda">
                <div class="card card-custom p-4">
                    <h5 class="text-white border-bottom border-secondary pb-2 mb-3">Pr√≥ximos Cortes</h5>
                    <div id="lista-agendamentos" class="d-flex flex-column gap-3">
                        <div class="text-center text-secondary small">Carregando agenda...</div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-horarios">
                <div class="card card-custom p-4">
                    <label class="text-warning small fw-bold mb-2">SELECIONE O DIA</label>
                    <input type="date" id="data-agenda" class="form-control mb-4" onchange="verificarExistentes()">

                    <label class="text-warning small fw-bold mb-3">MARQUE OS HOR√ÅRIOS LIVRES</label>
                    <div id="container-horarios" class="d-flex flex-wrap gap-2 justify-content-center mb-4"></div>

                    <button onclick="salvarHorarios()" class="btn btn-gold w-100 fw-bold py-3">SALVAR DISPONIBILIDADE</button>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API = "http://192.168.15.61:3000"; // SEU IP AQUI
        const usuario = JSON.parse(localStorage.getItem("usuario"));

        if (!usuario || usuario.tipo !== "barbeiro") {
            window.location.href = "index.html";
        } else {
            document.getElementById("ola-barbeiro").innerText = `Ol√°, ${usuario.nome.split(' ')[0]}`;
            gerarHorarios();
            carregarMeusAgendamentos(); // Carrega a lista assim que abre
        }

        // --- FUN√á√ÉO NOVA: BUSCAR QUEM AGENDOU COMIGO ---
        async function carregarMeusAgendamentos() {
            const lista = document.getElementById("lista-agendamentos");
            try {
                // Precisamos criar essa rota no Backend, mas vamos tentar puxar tudo e filtrar por enquanto
                const res = await fetch(`${API}/ver-agendamentos`);
                const todosAgendamentos = await res.json();
                
                // Filtra apenas os agendamentos DESTE barbeiro
                const meusAgendamentos = todosAgendamentos.filter(a => a.barbeiroId === usuario.id);

                lista.innerHTML = "";
                
                if (meusAgendamentos.length === 0) {
                    lista.innerHTML = '<div class="alert alert-dark w-100 border-secondary small text-center">Nenhum corte agendado ainda.</div>';
                    return;
                }

                // Ordena por data e hora
                meusAgendamentos.sort((a, b) => new Date(`${a.data}T${a.horario}`) - new Date(`${b.data}T${b.horario}`));

                meusAgendamentos.forEach(ag => {
                    // Formata Data (YYYY-MM-DD -> DD/MM)
                    const dataFormatada = ag.data.split('-').reverse().slice(0, 2).join('/');
                    
                    // Link Google Agenda
                    const dataG = ag.data.replace(/-/g, '') + 'T' + ag.horario.replace(':', '') + '00';
                    const linkGoogle = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=Corte%20-${encodeURIComponent(ag.cliente.nome)}&dates=${dataG}/${dataG}&details=Cliente:%20${encodeURIComponent(ag.cliente.email)}`;

                    const item = document.createElement("div");
                    item.className = "d-flex justify-content-between align-items-center bg-dark p-3 rounded border border-secondary";
                    item.innerHTML = `
                        <div>
                            <div class="text-warning fw-bold fs-5">${ag.horario} <span class="text-secondary fs-6">(${dataFormatada})</span></div>
                            <div class="text-white small">${ag.cliente.nome}</div>
                        </div>
                        <a href="${linkGoogle}" target="_blank" class="btn btn-sm btn-outline-light">
                            üìÖ Add Agenda
                        </a>
                    `;
                    lista.appendChild(item);
                });

            } catch (err) {
                console.error(err);
                lista.innerHTML = '<div class="text-danger small text-center">Erro ao carregar agenda.</div>';
            }
        }

        // --- FUN√á√ïES ANTIGAS (MANTIDAS) ---
        function gerarHorarios() {
            const container = document.getElementById("container-horarios");
            container.innerHTML = ""; 
            let horaAtual = 8 * 60; const horaFim = 20 * 60;
            while (horaAtual < horaFim) {
                const h = Math.floor(horaAtual / 60).toString().padStart(2, '0');
                const m = (horaAtual % 60).toString().padStart(2, '0');
                const horaString = `${h}:${m}`;
                const html = `
                    <input type="checkbox" class="btn-check" id="check-${horaString}" value="${horaString}">
                    <label class="btn btn-outline-warning btn-sm mb-2" for="check-${horaString}" style="width: 70px;">${horaString}</label>
                `;
                container.insertAdjacentHTML('beforeend', html);
                horaAtual += 30;
            }
        }

        async function verificarExistentes() {
            const data = document.getElementById("data-agenda").value;
            if(!data) return;
            document.querySelectorAll(".btn-check").forEach(c => c.checked = false);
            try {
                const res = await fetch(`${API}/disponibilidade/${usuario.id}/${data}`);
                const json = await res.json();
                if (json.horarios) {
                    json.horarios.forEach(h => {
                        const check = document.getElementById(`check-${h}`);
                        if(check) check.checked = true;
                    });
                }
            } catch (err) { }
        }

        async function salvarHorarios() {
            const data = document.getElementById("data-agenda").value;
            if (!data) return Swal.fire("Aten√ß√£o", "Selecione uma data primeiro!", "warning");
            const selecionados = Array.from(document.querySelectorAll(".btn-check:checked")).map(el => el.value);
            const horariosString = selecionados.join(",");
            try {
                Swal.showLoading();
                const res = await fetch(`${API}/disponibilidade`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ barbeiroId: usuario.id, data, horarios: horariosString })
                });
                if (res.ok) Swal.fire("Sucesso", "Agenda atualizada!", "success");
                else Swal.fire("Erro", "Falha ao salvar.", "error");
            } catch (err) { Swal.fire("Erro", "Erro de conex√£o.", "error"); }
        }

        function logout() { localStorage.clear(); window.location.href = "index.html"; }
    </script>
</body>
</html>