<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Barbeiro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #212529;
            color: white;
            min-height: 100vh;
            padding-top: 30px;
        }
        .card-custom {
            background-color: #2c3034;
            border: 1px solid #444;
        }
        /* Estilo para quando o bot√£o (checkbox) estiver marcado */
        .btn-check:checked + .btn-outline-warning {
            background-color: #ffc107;
            color: #000;
            font-weight: bold;
        }
        /* Ajuste de tamanho para caberem muitos hor√°rios */
        .grid-horarios {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container pb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Painel do Barbeiro ‚úÇÔ∏è</h1>
            <button onclick="logout()" class="btn btn-danger btn-sm">Sair</button>
        </div>

        <p class="lead">Bem-vindo, <strong id="nome-barbeiro" class="text-warning">...</strong></p>

        <div class="row">
            <div class="col-md-5 mb-4">
                <div class="card card-custom p-3">
                    <h4 class="mb-3">üìÖ Cortes Agendados</h4>
                    <div id="lista-agendamentos" style="max-height: 500px; overflow-y: auto;">
                        <div class="alert alert-secondary">Carregando agenda...</div>
                    </div>
                </div>
            </div>

            <div class="col-md-7">
                <div class="card card-custom p-3">
                    <h4 class="mb-3">‚ûï Abrir Nova Data</h4>
                    <form onsubmit="abrirAgenda(event)">
                        <div class="mb-3">
                            <label class="form-label">Selecione o Dia:</label>
                            <input type="date" id="data-agenda" class="form-control" required>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Hor√°rios Dispon√≠veis:</label>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-light" onclick="marcarTodos(true)">Todos</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="marcarTodos(false)">Nenhum</button>
                            </div>
                        </div>

                        <div id="container-horarios" class="grid-horarios mb-3"></div>

                        <button type="submit" class="btn btn-success w-100 fw-bold">Salvar Disponibilidade</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = "http://localhost:3000";
        const usuarioLogado = JSON.parse(localStorage.getItem("usuario"));

        // Prote√ß√£o de Rota
        if (!usuarioLogado || usuarioLogado.tipo !== "barbeiro") {
            window.location.href = "index.html";
        } else {
            document.getElementById("nome-barbeiro").innerText = usuarioLogado.nome;
            carregarAgenda();
            gerarHorarios(); // GERA OS BOT√ïES ASSIM QUE A TELA ABRE
        }

        // --- FUN√á√ÉO M√ÅGICA PARA GERAR HOR√ÅRIOS ---
        function gerarHorarios() {
            const container = document.getElementById("container-horarios");
            container.innerHTML = ""; // Limpa antes de gerar

            const horaInicio = 5;  // 05:00 da manh√£
            const horaFim = 23;    // 23:00 da noite

            for (let i = horaInicio; i <= horaFim; i++) {
                // Formata o numero para ter dois digitos (ex: 5 vira "05")
                const horaString = i.toString().padStart(2, '0') + ":00";
                
                // Cria o HTML do checkbox dinamicamente
                // Usamos o ID √∫nico baseado na hora (ex: check-05:00)
                const html = `
                    <input type="checkbox" class="btn-check" id="check-${horaString}" value="${horaString}">
                    <label class="btn btn-outline-warning w-100" for="check-${horaString}">${horaString}</label>
                `;
                
                // Adiciona ao container (precisa converter string pro DOM ou usar insertAdjacentHTML)
                container.insertAdjacentHTML('beforeend', html);
            }
            
            // Adiciona tamb√©m a meia-noite se quiser (00:00)
             /* const meiaNoite = `
                <input type="checkbox" class="btn-check" id="check-00:00" value="00:00">
                <label class="btn btn-outline-warning w-100" for="check-00:00">00:00</label>
             `;
             container.insertAdjacentHTML('beforeend', meiaNoite);
             */
        }

        function marcarTodos(status) {
            const checkboxes = document.querySelectorAll('.btn-check');
            checkboxes.forEach(cb => cb.checked = status);
        }

        async function carregarAgenda() {
            const lista = document.getElementById("lista-agendamentos");
            try {
                const res = await fetch(`${API}/ver-agendamentos`);
                const agendamentos = await res.json();
                
                lista.innerHTML = ""; 

                const meusAgendamentos = agendamentos.filter(a => a.barbeiroId == usuarioLogado.id);

                if (meusAgendamentos.length === 0) {
                    lista.innerHTML = '<div class="alert alert-dark">Nenhum corte agendado.</div>';
                    return;
                }

                meusAgendamentos.forEach(item => {
                    const nomeCliente = item.cliente ? item.cliente.nome : `ID: ${item.clienteId}`;
                    const emailCliente = item.cliente ? item.cliente.email : '';

                    const card = document.createElement("div");
                    card.className = "card mb-2 bg-dark border-secondary";
                    card.innerHTML = `
                        <div class="card-body p-2">
                            <h6 class="text-warning mb-1">üìÖ ${item.data} - ${item.horario}</h6>
                            <p class="mb-0 small">
                                ‚úÇÔ∏è <strong>Cliente:</strong> ${nomeCliente} <br>
                                üìß ${emailCliente}
                            </p>
                        </div>
                    `;
                    lista.appendChild(card);
                });

            } catch (err) {
                console.error(err);
                lista.innerHTML = '<div class="alert alert-danger">Erro ao carregar agenda.</div>';
            }
        }

        async function abrirAgenda(event) {
            event.preventDefault();
            
            const data = document.getElementById("data-agenda").value;
            
            // Pega todos os checkboxes marcados
            const checkboxes = document.querySelectorAll('.btn-check:checked');
            const horariosSelecionados = Array.from(checkboxes).map(cb => cb.value);

            if (horariosSelecionados.length === 0) {
                alert("Selecione pelo menos um hor√°rio!");
                return;
            }

            const horariosString = horariosSelecionados.join(",");

            try {
                const res = await fetch(`${API}/disponibilidade`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        barbeiroId: usuarioLogado.id,
                        data: data,
                        horarios: horariosString
                    })
                });

                const resposta = await res.json();

                if (res.ok) {
                    alert(resposta.mensagem);
                } else {
                    alert("Erro: " + resposta.erro);
                }
            } catch (err) {
                alert("Erro ao conectar com servidor");
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = "index.html";
        }
    </script>
</body>
</html>