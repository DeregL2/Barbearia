<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .horario-btn { border: 1px solid var(--gold); color: var(--gold); background: transparent; }
        .horario-btn:hover, .horario-selecionado { background-color: var(--gold) !important; color: #000 !important; font-weight: bold; }
    </style>
</head>
<body class="bg-cliente">

    <nav class="navbar navbar-custom mb-4">
        <div class="container">
            <a href="barbeiros.html" class="btn btn-outline-light btn-sm">‚Üê VOLTAR</a>
            <span class="brand-font h5 m-0 text-white">Agendamento</span>
            <button onclick="logout()" class="btn btn-outline-danger btn-sm">SAIR</button>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card card-custom p-4">
                    <h4 class="text-center mb-4 text-white">Finalizar Reserva</h4>
                    
                    <div class="mb-3">
                        <label class="form-label text-warning small fw-bold">1. ESCOLHA O DIA</label>
                        <input id="data" type="date" class="form-control" onchange="carregarHorarios()">
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-warning small fw-bold">2. ESCOLHA O HOR√ÅRIO</label>
                        <div id="lista-horarios" class="d-flex flex-wrap gap-2 justify-content-center">
                            <div class="alert alert-dark w-100 text-center border-secondary text-secondary small">
                                Selecione uma data acima üëÜ
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-dark border-warning text-center mb-3">
                        <small class="text-secondary d-block">Sinal para reservar:</small>
                        <strong id="sinal-display" class="text-warning fs-5">Carregando...</strong>
                    </div>

                    <button onclick="confirmarAgendamento()" class="btn btn-gold w-100 py-3 fw-bold">
                        PAGAR E CONFIRMAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = "http://localhost:3000";
        
        // Vari√°veis globais para guardar os pre√ßos do dia
        let PRECO_TOTAL = 0;
        let PRECO_SINAL = 0;

        let horarioSelecionado = null;
        const barbeiroId = localStorage.getItem("barbeiroId");
        if (!barbeiroId) window.location.href = "barbeiros.html";

        function logout() { localStorage.clear(); window.location.href = "index.html"; }

        // 1. CARREGA OS PRE√áOS ASSIM QUE ABRE A TELA
        async function carregarValores() {
            try {
                const res = await fetch(`${API}/configuracao`);
                const config = await res.json();
                
                PRECO_TOTAL = config.precoCorte;
                PRECO_SINAL = config.precoSinal;

                // Mostra na tela pro cliente saber quanto pagar
                document.getElementById("sinal-display").innerText = `R$ ${PRECO_SINAL.toFixed(2)}`;
            } catch (err) {
                alert("Erro ao carregar valores da loja.");
            }
        }

        async function carregarHorarios() {
            const dataInput = document.getElementById("data").value;
            const lista = document.getElementById("lista-horarios");
            if (!dataInput) return;
            
            lista.innerHTML = '<div class="text-center text-warning small">Carregando...</div>';
            horarioSelecionado = null;

            try {
                const res = await fetch(`${API}/disponibilidade/${barbeiroId}/${dataInput}`);
                const resultado = await res.json();
                lista.innerHTML = "";

                if (resultado.horarios.length === 0) {
                    lista.innerHTML = '<div class="alert alert-dark w-100 border-secondary small">Sem hor√°rios hoje.</div>';
                    return;
                }
                resultado.horarios.forEach(hora => {
                    const btn = document.createElement("button");
                    btn.className = "btn horario-btn px-3 py-1 btn-sm";
                    btn.innerText = hora;
                    btn.onclick = () => {
                        document.querySelectorAll("#lista-horarios button").forEach(b => b.classList.remove("horario-selecionado"));
                        btn.classList.add("horario-selecionado");
                        horarioSelecionado = hora;
                    };
                    lista.appendChild(btn);
                });
            } catch (err) { lista.innerHTML = '<div class="text-danger small">Erro.</div>'; }
        }

        async function confirmarAgendamento() {
            const dataInput = document.getElementById("data").value;
            const usuario = JSON.parse(localStorage.getItem("usuario"));
            
            if (!usuario) return logout();
            if (!dataInput || !horarioSelecionado) return alert("Selecione data e hor√°rio!");

            // USA OS VALORES QUE VIERAM DO BANCO DE DADOS
            const confirmacao = confirm(
                `üí∞ PAGAMENTO OBRIGAT√ìRIO\n\n` +
                `Valor Total do Corte: R$ ${PRECO_TOTAL.toFixed(2)}\n` +
                `Sinal para Agendar: R$ ${PRECO_SINAL.toFixed(2)}\n\n` +
                `Chave PIX: adm@barbearia.com\n\n` +
                `Clique em OK se voc√™ realizou o PIX.`
            );

            if (!confirmacao) return;

            try {
                const res = await fetch(`${API}/agendar`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ clienteId: usuario.id, barbeiroId: parseInt(barbeiroId), data: dataInput, horario: horarioSelecionado })
                });
                const resp = await res.json();
                if (res.ok) { alert("‚úÖ " + resp.mensagem); window.location.href = "barbeiros.html"; }
                else alert("‚ö†Ô∏è " + resp.erro);
            } catch (err) { alert("Erro de conex√£o."); }
        }

        // Inicia tudo
        carregarValores();
    </script>
</body>
</html>