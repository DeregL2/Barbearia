<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meus Cortes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-cliente">

    <nav class="navbar navbar-custom mb-4">
        <div class="container">
            <a href="barbeiros.html" class="btn btn-outline-light btn-sm">← VOLTAR</a>
            <span class="brand-font h5 m-0 text-white">Meus Cortes</span>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card card-custom p-4">
                    <h5 class="text-white mb-4 border-bottom border-secondary pb-2">Agendamentos Futuros</h5>
                    <div id="lista-meus-cortes" class="d-flex flex-column gap-3">
                        <div class="text-center text-warning small">Carregando...</div>
                    </div>
                </div>
                
                <div class="alert alert-dark mt-3 text-secondary small border-secondary">
                    ℹ️ Cancelamentos só são permitidos com <strong>24 horas</strong> de antecedência.
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = "http://192.168.15.61:3000"; // SEU IP
        const usuario = JSON.parse(localStorage.getItem("usuario"));
        
        if(!usuario) window.location.href = "index.html";

        async function carregarMeusCortes() {
            const lista = document.getElementById("lista-meus-cortes");
            try {
                // Pega todos (Num app real, filtrariamos no backend, mas aqui filtramos no front)
                const res = await fetch(`${API}/ver-agendamentos`);
                const todos = await res.json();
                
                // Filtra só os MEUS
                const meus = todos.filter(a => a.clienteId === usuario.id);
                
                lista.innerHTML = "";

                if (meus.length === 0) {
                    lista.innerHTML = '<div class="text-center text-secondary">Você não tem agendamentos.</div>';
                    return;
                }

                // Ordena por data
                meus.sort((a, b) => new Date(a.data) - new Date(b.data));

                meus.forEach(ag => {
                    const dataFormatada = ag.data.split('-').reverse().slice(0, 2).join('/');
                    
                    const div = document.createElement("div");
                    div.className = "d-flex justify-content-between align-items-center bg-dark p-3 rounded border border-warning";
                    div.innerHTML = `
                        <div>
                            <div class="text-white fw-bold">${ag.barbeiro.nome}</div>
                            <div class="text-warning small">Dia ${dataFormatada} às ${ag.horario}</div>
                        </div>
                        <button onclick="cancelar(${ag.id})" class="btn btn-sm btn-outline-danger">
                            Cancelar
                        </button>
                    `;
                    lista.appendChild(div);
                });

            } catch (err) { lista.innerHTML = '<div class="text-danger">Erro ao carregar.</div>'; }
        }

        async function cancelar(id) {
            const confirmacao = await Swal.fire({
                title: 'Cancelar corte?',
                text: "Se faltar menos de 24h, não será permitido.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Sim, cancelar'
            });

            if (confirmacao.isConfirmed) {
                try {
                    const res = await fetch(`${API}/agendar/${id}`, { method: 'DELETE' });
                    const json = await res.json();

                    if (res.ok) {
                        Swal.fire("Cancelado!", json.mensagem, "success");
                        carregarMeusCortes();
                    } else {
                        Swal.fire("Erro", json.erro, "error");
                    }
                } catch (err) { Swal.fire("Erro", "Erro de conexão", "error"); }
            }
        }

        carregarMeusCortes();
    </script>
</body>
</html>