<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Hor√°rio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <style>
        body {
            background-color: #212529;
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            max-width: 500px;
        }
        .card-custom {
            background-color: #2c3034;
            border: 1px solid #444;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .btn-outline-warning:hover {
            color: #000;
            font-weight: bold;
        }
        /* Classe para marcar o hor√°rio selecionado */
        .horario-selecionado {
            background-color: #ffc107 !important;
            color: #000 !important;
            font-weight: bold;
            border-color: #ffc107 !important;
        }
        .grid-horarios {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="card card-custom p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="text-warning">üíà Agendamento</h2>
                <a href="barbeiros.html" class="btn btn-sm btn-outline-light">Voltar</a>
            </div>

            <p class="text-secondary">Escolha o dia e o hor√°rio para seu corte.</p>

            <div class="mb-4">
                <label class="form-label">Data:</label>
                <input id="data" type="date" class="form-control" onchange="carregarHorarios()">
            </div>

            <div class="mb-4">
                <label class="form-label">Hor√°rios Dispon√≠veis:</label>
                <div id="lista-horarios" class="grid-horarios">
                    <div class="alert alert-dark w-100 text-center">
                        Selecione uma data acima üëÜ
                    </div>
                </div>
            </div>

            <button onclick="confirmarAgendamento()" class="btn btn-warning w-100 fw-bold btn-lg">
                Confirmar Agendamento
            </button>
        </div>
    </div>

    <script>
        const API = "http://localhost:3000";
        let horarioSelecionado = null;

        // Verifica se o usu√°rio selecionou um barbeiro antes de entrar aqui
        const barbeiroId = localStorage.getItem("barbeiroId");
        if (!barbeiroId) {
            alert("Selecione um barbeiro primeiro!");
            window.location.href = "barbeiros.html";
        }

        async function carregarHorarios() {
            const dataInput = document.getElementById("data").value;
            const lista = document.getElementById("lista-horarios");

            if (!dataInput) return;

            lista.innerHTML = '<div class="text-center text-warning">Buscando hor√°rios...</div>';
            horarioSelecionado = null; // Reseta sele√ß√£o ao mudar data

            try {
                // Chama a API que busca a disponibilidade do banco
                const res = await fetch(`${API}/disponibilidade/${barbeiroId}/${dataInput}`);
                const resultado = await res.json();

                lista.innerHTML = "";

                if (resultado.horarios.length === 0) {
                    lista.innerHTML = '<div class="alert alert-secondary w-100">Nenhum hor√°rio livre nesta data. üò¢</div>';
                    return;
                }

                // Cria um bot√£o para cada hor√°rio dispon√≠vel
                resultado.horarios.forEach(hora => {
                    const btn = document.createElement("button");
                    btn.className = "btn btn-outline-warning";
                    btn.innerText = hora;
                    
                    btn.onclick = () => {
                        // Remove a classe 'selecionado' de todos
                        document.querySelectorAll("#lista-horarios button").forEach(b => b.classList.remove("horario-selecionado"));
                        // Adiciona neste
                        btn.classList.add("horario-selecionado");
                        horarioSelecionado = hora;
                    };

                    lista.appendChild(btn);
                });

            } catch (err) {
                console.error(err);
                lista.innerHTML = '<div class="alert alert-danger">Erro ao carregar.</div>';
            }
        }

        async function confirmarAgendamento() {
            const dataInput = document.getElementById("data").value;
            const usuario = JSON.parse(localStorage.getItem("usuario"));

            if (!usuario) {
                alert("Voc√™ precisa estar logado!");
                window.location.href = "index.html";
                return;
            }

            if (!dataInput || !horarioSelecionado) {
                alert("Por favor, selecione uma Data e um Hor√°rio.");
                return;
            }

            try {
                const res = await fetch(`${API}/agendar`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        clienteId: usuario.id,
                        barbeiroId: parseInt(barbeiroId),
                        data: dataInput,
                        horario: horarioSelecionado
                    })
                });

                const resposta = await res.json();

                if (res.ok) {
                    alert("‚úÖ " + resposta.mensagem);
                    window.location.href = "barbeiros.html"; // Volta para a Home
                } else {
                    alert("‚ö†Ô∏è " + resposta.erro); // Exibe o erro (ex: "J√° tem agendamento hoje")
                }

            } catch (err) {
                console.error(err);
                alert("Erro de conex√£o com o servidor.");
            }
        }
    </script>
</body>
</html>